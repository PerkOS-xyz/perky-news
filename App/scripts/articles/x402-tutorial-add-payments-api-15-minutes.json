{
  "slug": "x402-tutorial-add-payments-api-15-minutes",
  "title": "x402 Tutorial: Add Payments to Your API in 15 Minutes",
  "category": "x402",
  "tags": ["x402", "tutorial", "payments", "API", "USDC", "Base", "developers"],
  "excerpt": "A practical step-by-step guide to monetizing your API using the x402 protocol. Transform any endpoint into a pay-per-call service with just a few lines of code.",
  "content": "# x402 Tutorial: Add Payments to Your API in 15 Minutes\n\nImagine monetizing your API the same way you'd add authentication—with just a few lines of code. That's exactly what the x402 protocol makes possible. In this hands-on tutorial, we'll transform a regular API endpoint into a pay-per-call service that accepts USDC payments on Base.\n\n## What You'll Build\n\nBy the end of this tutorial, you'll have:\n- An API endpoint protected by x402 payments\n- Automatic payment verification\n- A working payment flow that accepts USDC\n\n## Prerequisites\n\nBefore we start, make sure you have:\n- Node.js 18+ installed\n- A basic understanding of REST APIs\n- A wallet address to receive payments (we'll use Base network)\n\n## Understanding the x402 Flow\n\nThe x402 protocol leverages HTTP's rarely-used 402 status code (\"Payment Required\"). Here's how it works:\n\n1. Client requests your API endpoint\n2. Server responds with 402 and payment details\n3. Client creates a payment voucher (signed message)\n4. Client retries with the voucher in headers\n5. Server verifies and processes the request\n6. Facilitator settles the payment on-chain\n\nThis \"optimistic\" approach means requests aren't blocked waiting for blockchain confirmations—payments settle asynchronously.\n\n## Step 1: Set Up Your Project\n\nLet's create a new project:\n\n```bash\nmkdir x402-api-demo && cd x402-api-demo\nnpm init -y\nnpm install express @perkos/x402-server\n```\n\nThe `@perkos/x402-server` package provides middleware that handles all the payment logic.\n\n## Step 2: Create a Basic Server\n\nCreate `server.js`:\n\n```javascript\nimport express from 'express';\nimport { x402 } from '@perkos/x402-server';\n\nconst app = express();\n\n// Your wallet address on Base\nconst PAYEE_ADDRESS = 'YOUR_WALLET_ADDRESS';\n\n// Configure x402 middleware\nconst paymentMiddleware = x402({\n  payeeAddress: PAYEE_ADDRESS,\n  network: 'base',\n  acceptedTokens: ['USDC'],\n});\n\n// Free endpoint (no payment required)\napp.get('/health', (req, res) => {\n  res.json({ status: 'ok' });\n});\n\n// Paid endpoint: $0.001 per call\napp.get('/api/premium-data',\n  paymentMiddleware({ amount: '0.001', currency: 'USD' }),\n  (req, res) => {\n    res.json({\n      data: 'This is premium content!',\n      timestamp: new Date().toISOString(),\n      paymentId: req.x402?.paymentId\n    });\n  }\n);\n\napp.listen(3000, () => {\n  console.log('Server running on http://localhost:3000');\n});\n```\n\nThat's it! With about 20 lines of code, your endpoint now requires payment.\n\n## Step 3: Test the Payment Flow\n\nStart your server:\n\n```bash\nnode server.js\n```\n\nTry calling the endpoint without payment:\n\n```bash\ncurl http://localhost:3000/api/premium-data\n```\n\nYou'll get a 402 response with payment instructions:\n\n```json\n{\n  \"status\": 402,\n  \"message\": \"Payment Required\",\n  \"payment\": {\n    \"amount\": \"0.001\",\n    \"currency\": \"USD\",\n    \"network\": \"base\",\n    \"payee\": \"0x...\",\n    \"tokens\": [\"USDC\"]\n  },\n  \"facilitator\": \"https://facilitator.perkos.xyz\"\n}\n```\n\n## Step 4: Making Payments from a Client\n\nOn the client side, you'd handle this with the x402 client library:\n\n```javascript\nimport { x402Client } from '@perkos/x402-client';\n\nconst client = x402Client({\n  wallet: yourWalletProvider, // ethers.js signer, viem, etc.\n});\n\n// Automatic payment handling\nconst response = await client.fetch(\n  'http://localhost:3000/api/premium-data'\n);\n\nconsole.log(response.data);\n```\n\nThe client automatically:\n1. Detects the 402 response\n2. Creates an EIP-712 signed voucher\n3. Retries with the payment header\n4. Returns the actual response\n\n## Step 5: Different Pricing Models\n\nThe x402 middleware supports flexible pricing:\n\n```javascript\n// Per-call pricing\napp.get('/api/translate',\n  paymentMiddleware({ amount: '0.01', currency: 'USD' }),\n  translateHandler\n);\n\n// Dynamic pricing based on request\napp.post('/api/generate-image',\n  paymentMiddleware(req => ({\n    amount: req.body.quality === 'hd' ? '0.05' : '0.01',\n    currency: 'USD'\n  })),\n  imageHandler\n);\n\n// Free tier with limits\napp.get('/api/data',\n  paymentMiddleware({\n    amount: '0.001',\n    currency: 'USD',\n    freeQuota: 100, // First 100 calls free per day\n  }),\n  dataHandler\n);\n```\n\n## Step 6: Monitoring Payments\n\nTrack your earnings in real-time:\n\n```javascript\nimport { x402, onPayment } from '@perkos/x402-server';\n\n// Payment webhook\nonPayment((payment) => {\n  console.log(`Received ${payment.amount} USDC`);\n  console.log(`From: ${payment.payer}`);\n  console.log(`Endpoint: ${payment.path}`);\n});\n```\n\n## Security Considerations\n\nThe x402 protocol includes several security features:\n\n- **EIP-712 Signatures**: Payments are cryptographically signed\n- **Nonce Management**: Prevents replay attacks\n- **Facilitator Verification**: Trusted settlement layer\n- **Timeout Protection**: Vouchers expire after configurable time\n\n## Common Patterns\n\n### API Key + x402 Hybrid\n\n```javascript\napp.get('/api/premium',\n  apiKeyAuth,  // Your existing auth\n  paymentMiddleware({ amount: '0.001', currency: 'USD' }),\n  handler\n);\n```\n\n### Subscription Override\n\n```javascript\napp.get('/api/data',\n  paymentMiddleware({\n    amount: '0.001',\n    currency: 'USD',\n    skipIf: (req) => hasActiveSubscription(req.user)\n  }),\n  handler\n);\n```\n\n## Deployment Checklist\n\nBefore going to production:\n\n1. **Use environment variables** for wallet addresses\n2. **Set up monitoring** for payment events\n3. **Configure rate limiting** alongside payments\n4. **Test on Base Sepolia** before mainnet\n5. **Document your pricing** for API consumers\n\n## What's Next?\n\nYou've just built a payment-enabled API in 15 minutes. The x402 protocol opens up possibilities like:\n\n- **Micropayment-based AI services**\n- **Pay-per-query databases**\n- **Usage-based SaaS pricing**\n- **Agent-to-agent commerce**\n\n## Resources\n\n- [x402 Protocol Specification](https://github.com/coinbase/x402)\n- [PerkOS x402 Implementation](https://github.com/PerkOS-xyz/PerkOS)\n- [Base Network Docs](https://docs.base.org)\n\nThe future of API monetization is here, and it takes just 15 minutes to get started.",
  "sources": [
    "https://github.com/coinbase/x402",
    "https://docs.base.org"
  ],
  "author": "Perky News Team"
}
